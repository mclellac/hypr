#!/bin/bash
set -euo pipefail

# Configuration
CITY="Toronto"
CACHE_FILE="/tmp/hypr-weather-cache.json"
MAX_AGE=1800 # Optional: Consider data "stale" after 30 mins (not enforced here for reliability)

fetch_weather() {
    # 5s timeout to prevent Waybar hanging
    local raw_data
    # Added --retry 2 for better reliability
    raw_data=$(curl -s --max-time 5 --retry 2 "https://wttr.in/${CITY}?format=j1") || return 1

    # Check if we actually got valid JSON back
    if [[ -z "$raw_data" ]] || ! echo "$raw_data" | jq -e . >/dev/null 2>&1; then
        return 1
    fi

    # Process into Waybar format
    echo "$raw_data" | jq -r '
    .current_condition[0] as $c |
    ($c.weatherDesc[0].value // "Unknown") as $desc |
    (if ($desc | contains("Sunny")) or ($desc | contains("Clear")) then "ï†…"
     elif ($desc | contains("Partly cloudy")) then "ïƒ‚"
     elif ($desc | contains("Cloudy")) or ($desc | contains("Overcast")) then "â˜"
     elif ($desc | contains("Rain")) or ($desc | contains("rain")) then "ðŸŒ¦"
     elif ($desc | contains("Snow")) or ($desc | contains("snow")) then "ðŸŒ¨"
     elif ($desc | contains("Mist")) or ($desc | contains("Fog")) then "ðŸŒ«"
     else "ï††" end) as $icon |
    {
      text: "\($icon) \($c.temp_C // "??")Â°C",
      tooltip: "\($desc)\nFeels like: \($c.FeelsLikeC // "??")Â°C\nHumidity: \($c.humidity // "??")%\nWind: \($c.windspeedKmph // "??")km/h \($c.winddir16Point // "")"
    }'
}

main() {
    local new_weather

    # Try to fetch new data
    # Capture output and exit status separately to handle errors robustly
    if new_weather=$(fetch_weather) && [[ -n "$new_weather" ]] && echo "$new_weather" | jq -e . >/dev/null 2>&1; then
        # Success! Update cache and print
        echo "$new_weather" >"$CACHE_FILE"
        echo "$new_weather"
    else
        # Failure! Fallback to cache if it exists and is valid
        if [[ -f "$CACHE_FILE" ]] && jq -e . "$CACHE_FILE" >/dev/null 2>&1; then
            cat "$CACHE_FILE"
        else
            # Absolute fallback if no cache exists yet or it's invalid
            echo '{"text": "ï„ª", "tooltip": "Weather data unavailable (No Cache)"}'
        fi
    fi
}

main "$@"
