#!/bin/bash

set -euo pipefail

# Fetches weather for Toronto from wttr.in and formats it for Waybar.
main() {
  local city="Toronto"
  local url="https://wttr.in/${city}?format=j1"
  local weather
  weather=$(curl -s "${url}")

  if [[ -z "${weather}" ]]; then
    echo '{"text": "ï„ª", "tooltip": "Weather data unavailable"}'
    exit 0
  fi

  local condition
  condition=$(echo "${weather}" | jq -r '.current_condition[0].weatherDesc[0].value')
  local temp_c
  temp_c=$(echo "${weather}" | jq -r '.current_condition[0].temp_C')
  local feels_like_c
  feels_like_c=$(echo "${weather}" | jq -r '.current_condition[0].FeelsLikeC')
  local humidity
  humidity=$(echo "${weather}" | jq -r '.current_condition[0].humidity')
  local wind_speed
  wind_speed=$(echo "${weather}" | jq -r '.current_condition[0].windspeedKmph')
  local wind_dir
  wind_dir=$(echo "${weather}" | jq -r '.current_condition[0].winddir16Point')
  local pressure
  pressure=$(echo "${weather}" | jq -r '.current_condition[0].pressure')
  local visibility
  visibility=$(echo "${weather}" | jq -r '.current_condition[0].visibility')

  # Map weather condition to an icon
  local icon
  case "${condition}" in
    *Sunny*|*Clear*)
      icon="ï†…"
      ;;
    *Partly*Cloudy*)
      icon="ïƒ‚"
      ;;
    *Cloudy*|*Overcast*)
      icon="â˜"
      ;;
    *Mist*|*Fog*)
      icon="ğŸŒ«"
      ;;
    *Patchy*rain*|*Light*rain*|*rain*shower*)
      icon="ğŸŒ¦"
      ;;
    *Thundery*outbreaks*)
      icon="â›ˆ"
      ;;
    *snow*|*blizzard*)
      icon="ğŸŒ¨"
      ;;
    *)
      icon="ï††"
      ;;
  esac

  local text="${icon} ${temp_c}Â°C"
  local tooltip="${condition}\nFeels like ${feels_like_c}Â°C\nHumidity: ${humidity}%\nWind: ${wind_speed}km/h ${wind_dir}\nPressure: ${pressure}hPa\nVisibility: ${visibility}km"

  printf '{"text": "%s", "tooltip": "%s"}\n' "${text}" "${tooltip}"
}

main "$@"
