#!/bin/bash
set -euo pipefail

# Fetches weather for Toronto from wttr.in
main() {
    local city="Toronto"
    # Use a 5s timeout to stop Waybar from hanging if wttr.in is slow
    local weather
    weather=$(curl -s --max-time 5 "https://wttr.in/${city}?format=j1") || true

    if [[ -z "${weather}" || "${weather}" == "null" ]]; then
        echo '{"text": "ï„ª", "tooltip": "Weather data unavailable"}'
        exit 0
    fi

    # Robust JQ processing
    echo "${weather}" | jq -r '
    .current_condition[0] as $c |
    ($c.weatherDesc[0].value // "Unknown") as $desc |
    (if ($desc | contains("Sunny")) or ($desc | contains("Clear")) then "ï†…"
     elif ($desc | contains("Partly cloudy")) then "ïƒ‚"
     elif ($desc | contains("Cloudy")) or ($desc | contains("Overcast")) then "â˜"
     elif ($desc | contains("Rain")) or ($desc | contains("rain")) then "ğŸŒ¦"
     elif ($desc | contains("Snow")) or ($desc | contains("snow")) then "ğŸŒ¨"
     elif ($desc | contains("Mist")) or ($desc | contains("Fog")) then "ğŸŒ«"
     else "ï††" end) as $icon |
    {
      text: "\($icon) \($c.temp_C // "??")Â°C",
      tooltip: "\($desc)\nFeels like: \($c.FeelsLikeC // "??")Â°C\nHumidity: \($c.humidity // "??")%\nWind: \($c.windspeedKmph // "??")km/h \($c.winddir16Point // "")"
    }'
}

main "$@"
