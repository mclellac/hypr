#!/usr/bin/env python3
import json
import os
import sys

LOG_FILE = os.path.expanduser("~/.local/share/hypr/notifications.json")
STATE_FILE = os.path.expanduser("~/.local/share/hypr/notifications.state")

def main():
    count = 0
    tooltip = "No notifications"
    logs = []

    if os.path.exists(LOG_FILE):
        try:
            with open(LOG_FILE, 'r') as f:
                logs = json.load(f)
                if isinstance(logs, list):
                    count = len(logs)
                    if count > 0:
                        tooltip = f"{count} notification(s)\n(Mid click to clear)"
                        # Show the latest few in tooltip
                        latest = logs[:5]
                        tooltip += "\n\n"
                        for notif in latest:
                            app = notif.get("app_name", "Unknown")
                            summary = notif.get("summary", "")
                            tooltip += f"• {app}: {summary}\n"
        except Exception:
            pass

    # Read state
    last_read_count = 0
    if os.path.exists(STATE_FILE):
        try:
            with open(STATE_FILE, 'r') as f:
                state = json.load(f)
                last_read_count = state.get("last_read_count", 0)
        except Exception:
            pass

    # Determine class and text
    css_class = "empty"
    text = ""

    if count > 0:
        if count > last_read_count:
            css_class = "new"
        else:
            css_class = "read"
        text = f" {count}"

    output = {
        "text": text,
        "tooltip": tooltip,
        "class": css_class
    }

    print(json.dumps(output))

if __name__ == "__main__":
    main()
