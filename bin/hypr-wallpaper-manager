#!/usr/bin/env python3
"""
Hyprland Wallpaper Manager
A modern Libadwaita application to browse and set wallpapers.
"""

import sys
import json
import subprocess
import threading
import warnings
from pathlib import Path

try:
    import gi
    gi.require_version('Gtk', '4.0')
    gi.require_version('Adw', '1')
    from gi.repository import Gtk, Gdk, Adw, Gio, GLib, GdkPixbuf, GObject
except ImportError as e:
    print(f"Error: Missing dependencies. {e}", file=sys.stderr)
    print("Please ensure python-gobject, gtk4, and libadwaita are installed.", file=sys.stderr)
    sys.exit(1)
except ValueError as e:
    print(f"Error: {e}", file=sys.stderr)
    sys.exit(1)

# Suppress Adwaita warning about GtkSettings
# This warning is triggered by system configuration and cannot be fixed from the app side otherwise.
def adwaita_log_handler(domain, level, message, user_data):
    if "Using GtkSettings:gtk-application-prefer-dark-theme with libadwaita is unsupported" in message:
        return
    # Log other messages to stderr
    print(f"{domain}: {message}", file=sys.stderr)

try:
    GLib.log_set_handler("Adwaita", GLib.LogLevelFlags.LEVEL_WARNING | GLib.LogLevelFlags.FLAG_FATAL | GLib.LogLevelFlags.FLAG_RECURSION, adwaita_log_handler, None)
except Exception:
    pass

# Configuration
THEME_BG_DIR = Path.home() / ".config/hypr/current/theme/backgrounds"
USER_BG_DIR = Path.home() / ".local/share/hypr/wallpapers"
CONFIG_FILE = Path.home() / ".config/hypr/wallpaper-manager.json"

DEFAULT_CONFIG = {
    "extra_directories": [],
    "thumbnail_size": 200
}

class WallpaperManager(Adw.Application):
    def __init__(self):
        super().__init__(application_id="com.hypr.wallpaper.manager", flags=Gio.ApplicationFlags.FLAGS_NONE)
        self.config = self.load_config()

        # Set dark theme preference properly for Libadwaita
        manager = Adw.StyleManager.get_default()
        manager.set_color_scheme(Adw.ColorScheme.PREFER_DARK)

        # Ensure user directory exists
        USER_BG_DIR.mkdir(parents=True, exist_ok=True)

    def load_config(self):
        if not CONFIG_FILE.exists():
            return DEFAULT_CONFIG.copy()
        try:
            with open(CONFIG_FILE, 'r') as f:
                return {**DEFAULT_CONFIG, **json.load(f)}
        except Exception as e:
            print(f"Failed to load config: {e}", file=sys.stderr)
            return DEFAULT_CONFIG.copy()

    def save_config(self):
        try:
            CONFIG_FILE.parent.mkdir(parents=True, exist_ok=True)
            with open(CONFIG_FILE, 'w') as f:
                json.dump(self.config, f, indent=4)
        except Exception as e:
            print(f"Failed to save config: {e}", file=sys.stderr)

    def do_activate(self):
        win = self.props.active_window
        if not win:
            win = MainWindow(application=self, config=self.config, save_callback=self.save_config)
        win.present()

class MainWindow(Adw.ApplicationWindow):
    def __init__(self, *args, config, save_callback, **kwargs):
        super().__init__(*args, **kwargs)
        self.config = config
        self.save_callback = save_callback

        self.set_title("Wallpaper Manager")
        self.set_default_size(1200, 800)

        # Toolbar View Layout
        toolbar_view = Adw.ToolbarView()
        self.set_content(toolbar_view)

        # Header Bar
        header = Adw.HeaderBar()
        toolbar_view.add_top_bar(header)

        # Add Button (Left)
        btn_add = Gtk.Button(icon_name="list-add-symbolic")
        btn_add.set_tooltip_text("Add Wallpaper")
        btn_add.connect("clicked", self.on_add_clicked)
        header.pack_start(btn_add)

        # Right side buttons
        btn_prefs = Gtk.Button(icon_name="emblem-system-symbolic")
        btn_prefs.set_tooltip_text("Preferences")
        btn_prefs.connect("clicked", self.on_prefs_clicked)
        header.pack_end(btn_prefs)

        btn_refresh = Gtk.Button(icon_name="view-refresh-symbolic")
        btn_refresh.set_tooltip_text("Refresh")
        btn_refresh.connect("clicked", lambda x: self.load_wallpapers())
        header.pack_end(btn_refresh)

        # Toast Overlay
        self.toast_overlay = Adw.ToastOverlay()
        toolbar_view.set_content(self.toast_overlay)

        # Scroll Window for Grid
        scrolled = Gtk.ScrolledWindow()
        self.toast_overlay.set_child(scrolled)

        # FlowBox for Grid
        self.flowbox = Gtk.FlowBox()
        self.flowbox.set_valign(Gtk.Align.START)
        self.flowbox.set_max_children_per_line(30) # Auto-flow
        self.flowbox.set_selection_mode(Gtk.SelectionMode.NONE)
        self.flowbox.set_column_spacing(20)
        self.flowbox.set_row_spacing(20)
        self.flowbox.set_margin_top(20)
        self.flowbox.set_margin_bottom(20)
        self.flowbox.set_margin_start(20)
        self.flowbox.set_margin_end(20)
        scrolled.set_child(self.flowbox)

        self.load_wallpapers()

    def load_wallpapers(self):
        # Clear existing
        child = self.flowbox.get_first_child()
        while child:
            next_child = child.get_next_sibling()
            self.flowbox.remove(child)
            child = next_child

        # Find images
        extensions = {'.jpg', '.jpeg', '.png', '.webp', '.bmp'}
        paths = []

        directories = [THEME_BG_DIR, USER_BG_DIR]
        for extra in self.config.get("extra_directories", []):
            directories.append(Path(extra))

        for d in directories:
            if d.exists():
                for f in d.iterdir():
                    if f.is_file() and f.suffix.lower() in extensions:
                        paths.append(f)

        paths = sorted(list(set(paths)))

        if not paths:
            # Show empty state
            status = Adw.StatusPage(
                icon_name="image-x-generic-symbolic",
                title="No Wallpapers Found",
                description="Add directories in preferences or drop images here."
            )
            # Replace flowbox temporarily or just append?
            # Ideally switch stack, but appending label is easier for now
            # Actually, let's keep it simple.
            self.flowbox.append(status)
            return

        threading.Thread(target=self.load_thumbnails_thread, args=(paths,), daemon=True).start()

    def load_thumbnails_thread(self, paths):
        size = self.config.get("thumbnail_size", 200)
        for path in paths:
            try:
                pixbuf = GdkPixbuf.Pixbuf.new_from_file_at_scale(
                    str(path), size, size, True
                )
                GLib.idle_add(self.add_thumbnail, path, pixbuf)
            except Exception:
                pass

    def add_thumbnail(self, path, pixbuf):
        size = self.config.get("thumbnail_size", 200)

        vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=5)

        # Use Gdk.Texture for GTK4 compliance
        # Suppress deprecation warning for new_for_pixbuf as new_from_bytes is complex
        with warnings.catch_warnings():
            warnings.simplefilter("ignore")
            texture = Gdk.Texture.new_for_pixbuf(pixbuf)
        img = Gtk.Image.new_from_paintable(texture)
        img.set_pixel_size(size)
        img.add_css_class("card") # Libadwaita style

        btn = Gtk.Button()
        btn.set_child(img)
        # Avoid double-firing or focus issues by ensuring we only react to explicit activation
        btn.connect("clicked", self.on_wallpaper_clicked, path)
        btn.add_css_class("flat")

        vbox.append(btn)

        lbl = Gtk.Label(label=path.name)
        lbl.set_ellipsize(3)
        lbl.set_max_width_chars(int(size / 10))
        lbl.set_wrap(False)
        vbox.append(lbl)

        self.flowbox.append(vbox)
        return False

    def on_wallpaper_clicked(self, btn, path):
        try:
            subprocess.run(["hypr-wallpaper-set", str(path)], check=True)
            self.show_toast(f"Set: {path.name}")
        except Exception as e:
            print(f"Error: {e}", file=sys.stderr)
            self.show_toast(f"Error: {e}")

    def on_add_clicked(self, btn):
        dialog = Gtk.FileDialog()
        dialog.set_title("Select Wallpaper")

        filter_list = Gio.ListStore.new(Gtk.FileFilter)
        img_filter = Gtk.FileFilter()
        img_filter.set_name("Images")
        for mime in ["image/jpeg", "image/png", "image/webp", "image/bmp"]:
            img_filter.add_mime_type(mime)
        filter_list.append(img_filter)
        dialog.set_filters(filter_list)
        dialog.set_default_filter(img_filter)

        dialog.open(self, None, self.on_file_selected)

    def on_file_selected(self, dialog, result):
        try:
            file = dialog.open_finish(result)
            src_path = Path(file.get_path())
            parent_dir = src_path.parent

            # Instead of copying, we add the directory to our source list if not present
            path_str = str(parent_dir)
            if "extra_directories" not in self.config:
                self.config["extra_directories"] = []

            if path_str not in self.config["extra_directories"]:
                self.config["extra_directories"].append(path_str)
                self.save_config()
                self.show_toast(f"Added directory: {parent_dir.name}")
            else:
                self.show_toast(f"Directory already added: {parent_dir.name}")

            self.load_wallpapers()
        except Exception as e:
            print(f"Error adding file source: {e}", file=sys.stderr)

    def show_toast(self, message):
        toast = Adw.Toast(title=message)
        self.toast_overlay.add_toast(toast)

    def on_prefs_clicked(self, btn):
        prefs = PreferencesWindow(transient_for=self, config=self.config, save_callback=self.save_callback, on_change=self.load_wallpapers)
        prefs.present()

class PreferencesWindow(Adw.PreferencesWindow):
    def __init__(self, config, save_callback, on_change, **kwargs):
        super().__init__(**kwargs)
        self.config = config
        self.save_callback = save_callback
        self.on_change = on_change

        page = Adw.PreferencesPage()
        if hasattr(self, "add_page"):
            self.add_page(page)
        else:
            self.add(page)

        # Appearance Group
        grp_app = Adw.PreferencesGroup(title="Appearance")
        if hasattr(page, "add_group"):
            page.add_group(grp_app)
        else:
            page.add(grp_app)

        row_size = Adw.ActionRow(title="Thumbnail Size", subtitle="Adjust grid size (100-400px)")
        scale = Gtk.Scale.new_with_range(Gtk.Orientation.HORIZONTAL, 100, 400, 10)
        scale.set_value(config.get("thumbnail_size", 200))
        scale.set_hexpand(True)
        scale.set_size_request(150, -1)
        scale.connect("value-changed", self.on_size_changed)

        row_size.add_suffix(scale)
        grp_app.add(row_size)

        # Library Group
        grp_lib = Adw.PreferencesGroup(title="Library Directories", description="Extra paths to scan for wallpapers.")
        if hasattr(page, "add_group"):
            page.add_group(grp_lib)
        else:
            page.add(grp_lib)
        self.grp_lib = grp_lib

        # Add Directory Button Row
        self.row_add = Adw.ActionRow(title="Add New Directory")
        btn_add = Gtk.Button(icon_name="list-add-symbolic")
        btn_add.set_valign(Gtk.Align.CENTER)
        btn_add.connect("clicked", self.on_add_dir)
        self.row_add.add_suffix(btn_add)
        grp_lib.add(self.row_add)

        self.refresh_dirs()

    def on_size_changed(self, scale):
        self.config["thumbnail_size"] = int(scale.get_value())
        self.save_callback()
        self.on_change()

    def refresh_dirs(self):
        # Clear existing rows except the "Add" row if possible, or just clear all
        # AdwPreferencesGroup inherits from GtkWidget, so we can iterate children
        child = self.grp_lib.get_first_child()
        while child:
            next_child = child.get_next_sibling()
            # Don't remove the persistent "Add" row if we can identify it,
            # but it's easier to remove everything and re-add.
            # However, self.row_add is created in __init__.
            if child != self.row_add:
                 self.grp_lib.remove(child)
            child = next_child

        # Re-add directory rows BEFORE the add button
        # But AdwPreferencesGroup adds to the end.
        # So we must remove the add row, add dirs, then add it back.

        self.grp_lib.remove(self.row_add)

        # Add existing dirs
        for path_str in self.config.get("extra_directories", []):
            row = Adw.ActionRow(title=path_str)
            btn_del = Gtk.Button(icon_name="user-trash-symbolic")
            btn_del.set_valign(Gtk.Align.CENTER)
            btn_del.add_css_class("flat")
            btn_del.connect("clicked", self.on_remove_dir, path_str)
            row.add_suffix(btn_del)
            self.grp_lib.add(row)

        self.grp_lib.add(self.row_add)

    def on_remove_dir(self, btn, path_str):
        if path_str in self.config["extra_directories"]:
            self.config["extra_directories"].remove(path_str)
            self.save_callback()
            self.refresh_dirs()
            self.on_change()

    def on_add_dir(self, btn):
        dialog = Gtk.FileDialog()
        dialog.set_title("Select Directory")
        dialog.select_folder(self, None, self.on_folder_selected)

    def on_folder_selected(self, dialog, result):
        try:
            folder = dialog.select_folder_finish(result)
            path = folder.get_path()
            if path:
                if "extra_directories" not in self.config:
                    self.config["extra_directories"] = []
                if path not in self.config["extra_directories"]:
                    self.config["extra_directories"].append(path)
                    self.save_callback()
                    self.refresh_dirs()
                    self.on_change()
        except Exception:
            pass

if __name__ == "__main__":
    app = WallpaperManager()
    app.run(sys.argv)
