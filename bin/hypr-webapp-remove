#!/bin/bash
#
# Removes a web application's .desktop file and icon.

set -euo pipefail

readonly ICON_DIR="${HOME}/.local/share/applications/icons"
readonly DESKTOP_DIR="${HOME}/.local/share/applications"

#######################################
# Finds all installed web applications.
# Globals:
#   DESKTOP_DIR
# Arguments:
#   None
# Outputs:
#   A sorted, newline-separated list of web application names.
#######################################
find_web_apps() {
  local -a web_apps
  while IFS= read -r -d '' file; do
    if grep -q '^Exec=.*hypr-launch-webapp.*' "${file}"; then
      web_apps+=("$(basename "${file%.desktop}")")
    fi
  done < <(find "${DESKTOP_DIR}" -name '*.desktop' -print0)

  if ((${#web_apps[@]})); then
    IFS=$'\n'
    sorted_web_apps=($(sort <<<"${web_apps[*]}"))
    unset IFS
    printf "%s\n" "${sorted_web_apps[@]}"
  fi
}

#######################################
# Main function to remove web applications.
# Globals:
#   ICON_DIR
#   DESKTOP_DIR
# Arguments:
#   $@ - (Optional) A list of web application names to remove.
# Outputs:
#   None
#######################################
main() {
  local -a app_names
  if [[ "$#" -eq 0 ]]; then
    local web_apps
    web_apps=$(find_web_apps)
    if [[ -n "${web_apps}" ]]; then
      local app_names_string
      app_names_string=$(echo "${web_apps}" | gum choose --no-limit --header "Select web app to remove..." --selected-prefix="âœ— ")
      while IFS= read -r line; do
        [[ -n "${line}" ]] && app_names+=("${line}")
      done <<< "${app_names_string}"
    else
      echo "No web applications to remove."
      exit 0
    fi
  else
    app_names=("$@")
  fi

  if [[ ${#app_names[@]} -eq 0 ]]; then
    echo "No web applications selected for removal."
    exit 0
  fi

  for app_name in "${app_names[@]}"; do
    rm -f "${DESKTOP_DIR}/${app_name}.desktop"
    rm -f "${ICON_DIR}/${app_name}.png"
    echo "Removed ${app_name}"
  done
}

main "$@"
