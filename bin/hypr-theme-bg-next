#!/bin/bash
#
# Cycles through the background images available for the current theme.

set -euo pipefail

readonly BACKGROUNDS_DIR="${HOME}/.config/hypr/current/theme/backgrounds/"
readonly CURRENT_BACKGROUND_LINK="${HOME}/.config/hypr/current/background"

#######################################
# Sets a solid black background.
# Globals:
#   None
# Arguments:
#   None
# Outputs:
#   None
#######################################
set_black_background() {
  pkill -x swaybg || true
  setsid uwsm app -- swaybg --color '#000000' >/dev/null 2>&1 &
}

#######################################
# Sets the background to the image specified by the symlink.
# Globals:
#   CURRENT_BACKGROUND_LINK
# Arguments:
#   None
# Outputs:
#   None
#######################################
#######################################
# Main function to cycle to the next background.
# Globals:
#   BACKGROUNDS_DIR
#   CURRENT_BACKGROUND_LINK
# Arguments:
#   None
# Outputs:
#   None
#######################################
main() {
  if [[ ! -d "${BACKGROUNDS_DIR}" ]]; then
    notify-send "No background directory found for the current theme" -t 2000
    set_black_background
    exit 0
  fi

  local -a backgrounds
  mapfile -d '' -t backgrounds < <(find "${BACKGROUNDS_DIR}" -type f -print0 | sort -z)
  local total=${#backgrounds[@]}

  if [[ ${total} -eq 0 ]]; then
    notify-send "No background images found in the current theme" -t 2000
    set_black_background
    exit 0
  fi

  local current_background=""
  if [[ -L "${CURRENT_BACKGROUND_LINK}" ]]; then
    current_background=$(readlink "${CURRENT_BACKGROUND_LINK}")
  fi

  local current_index=-1
  for i in "${!backgrounds[@]}"; do
    if [[ "${backgrounds[$i]}" == "${current_background}" ]]; then
      current_index=$i
      break
    fi
  done

  local next_index=0
  if [[ ${current_index} -ne -1 ]]; then
    next_index=$(((current_index + 1) % total))
  fi

  local new_background="${backgrounds[${next_index}]}"
  hypr-wallpaper-set "${new_background}"
}

main
