#!/bin/bash
#
# Toggles the screen's color temperature between a 'nightlight' and 'daylight'
# setting using 'hyprsunset'.

set -euo pipefail

readonly ON_TEMP=4000
readonly OFF_TEMP=6000

#######################################
# Restarts Waybar if the nightlight module is enabled.
# Globals:
#   HOME - The user's home directory.
# Arguments:
#   None
# Outputs:
#   None
#######################################
restart_waybar_if_needed() {
  if grep -q "custom/nightlight" "${HOME}/.config/waybar/config.jsonc"; then
    hypr-restart-waybar
  fi
}

#######################################
# Main function to toggle the nightlight.
# Globals:
#   ON_TEMP
#   OFF_TEMP
# Arguments:
#   None
# Outputs:
#   None
#######################################
main() {
  # Ensure hyprsunset is running.
  if ! pgrep -x hyprsunset &>/dev/null; then
    setsid uwsm app -- hyprsunset &
    sleep 1 # Give it time to start.
  fi

  # Query the current temperature.
  local current_temp
  current_temp=$(hyprctl hyprsunset temperature 2>/dev/null | grep -oE '[0-9]+')

  if [[ "${current_temp}" == "${OFF_TEMP}" ]]; then
    hyprctl hyprsunset temperature "${ON_TEMP}"
    notify-send "  Nightlight On"
  else
    hyprctl hyprsunset temperature "${OFF_TEMP}"
    notify-send "   Nightlight Off"
  fi

  restart_waybar_if_needed
}

main
