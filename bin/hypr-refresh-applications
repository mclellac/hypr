#!/bin/bash
#
# Refreshes the system's application database by copying over custom .desktop
# files and icons, then updating the relevant caches.

set -euo pipefail

#######################################
# Main function to refresh the application database.
# Globals:
#   HYPR_PATH - The root path of the hypr configuration.
#   HOME - The user's home directory.
# Arguments:
#   None
# Outputs:
#   None
#######################################
main() {
  if [[ -z "${HYPR_PATH:-}" ]]; then
    echo "Error: HYPR_PATH environment variable is not set." >&2
    exit 1
  fi

  local local_icons_dir="${HOME}/.local/share/icons/hicolor/48x48/apps"
  local local_apps_dir="${HOME}/.local/share/applications"
  local source_icons_dir="${HYPR_PATH}/applications/icons"
  local source_apps_dir="${HYPR_PATH}/applications"
  local source_hidden_apps_dir="${HYPR_PATH}/applications/hidden"

  # Copy and sync icon files.
  echo "Syncing application icons..."
  mkdir -p "${local_icons_dir}"
  if ls "${source_icons_dir}"/*.png &>/dev/null; then
    cp "${source_icons_dir}"/*.png "${local_icons_dir}/"
  fi
  gtk-update-icon-cache "${HOME}/.local/share/icons/hicolor" &>/dev/null

  # Copy .desktop files.
  echo "Syncing .desktop files..."
  mkdir -p "${local_apps_dir}"
  if ls "${source_apps_dir}"/*.desktop &>/dev/null; then
    cp "${source_apps_dir}"/*.desktop "${local_apps_dir}/"
  fi
  if ls "${source_hidden_apps_dir}"/*.desktop &>/dev/null; then
    cp "${source_hidden_apps_dir}"/*.desktop "${local_apps_dir}/"
  fi

  # Update the desktop database if the command is available.
  if command -v update-desktop-database &>/dev/null; then
    echo "Updating desktop database..."
    update-desktop-database "${local_apps_dir}"
  fi

  echo "Application refresh complete."
}

main
