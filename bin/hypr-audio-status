#!/usr/bin/env python3
import json
import subprocess
import shutil

def main():
    if not shutil.which("pamixer"):
        print(json.dumps({"text": "err", "tooltip": "pamixer not found", "class": "error", "percentage": 0}))
        return

    try:
        # Check if muted
        muted_res = subprocess.run(["pamixer", "--get-mute"], capture_output=True, text=True)
        muted = muted_res.stdout.strip() == "true"

        # Get volume
        vol_res = subprocess.run(["pamixer", "--get-volume"], capture_output=True, text=True)
        try:
            volume = int(vol_res.stdout.strip())
        except ValueError:
            volume = 0

        tooltip = f"Volume: {volume}%"
        css_class = ""
        text = ""

        if muted or volume == 0:
            css_class = "muted"
            text = "󰝟"
            tooltip += " (Muted)"
        elif volume <= 50:
            css_class = "low"
            # Icons:  (low),  (med),  (high)
            if volume < 30: text = ""
            else: text = ""
        else:
            css_class = "high"
            text = ""

        output = {
            "text": text,
            "tooltip": tooltip,
            "class": css_class,
            "percentage": volume
        }

        print(json.dumps(output))

    except Exception as e:
        print(json.dumps({"text": "err", "tooltip": str(e), "class": "error", "percentage": 0}))

if __name__ == "__main__":
    main()
