#!/bin/bash
set -euo pipefail

# Get the default browser, with a timeout and fallback.
# xdg-settings can sometimes hang, so we wrap it in a timeout.
browser_desktop_file=$(timeout 1s xdg-settings get default-web-browser || echo "chromium.desktop")

# If the browser is still not found, exit with an error.
if [[ -z "${browser_desktop_file}" ]]; then
    echo "ERROR: Could not determine the default web browser." >&2
    exit 1
fi

# Find the executable path from the desktop file.
# We search in the standard application directories.
exec_path=$(sed -n 's/^Exec=\([^ ]*\).*/\1/p' "${HOME}/.local/share/applications/${browser_desktop_file}" \
    "${HOME}/.nix-profile/share/applications/${browser_desktop_file}" \
    "/usr/share/applications/${browser_desktop_file}" 2>/dev/null | head -1)

# If no executable path is found, exit with an error.
if [[ -z "${exec_path}" ]]; then
    echo "ERROR: Could not find the executable for '${browser_desktop_file}'." >&2
    exit 1
fi

# Launch the browser using uwsm.
exec setsid uwsm app -- "${exec_path}" "$@"
